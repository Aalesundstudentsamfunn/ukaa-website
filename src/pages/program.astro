---
import PageLayout from "../layouts/PageLayout.astro";
import Footer from "../components/Footer.astro";
import { getCollection, type CollectionEntry } from "astro:content";

type ProgramDay = {
  id: string;
  label: string;
  dateLabel?: string;
  summary?: string;
  order?: number;
  schedule?: ProgramItem[];
};

type ProgramItem = {
  time: string;
  title: string;
  location?: string;
  description?: string;
};

type ProgramEntry = CollectionEntry<"program">;

const programEntries: ProgramEntry[] = await getCollection("program");

const days = programEntries
  .map((entry) => entry.data as ProgramDay)
  .sort((a, b) => (a.order ?? 0) - (b.order ?? 0));

const title = "Program";
const dateRange = "12.–22. mars 2026";
const desc = "U.-KA. fyller Ålesund med konserter, show og opplevelser gjennom hele uka. Programmet oppdateres fortløpende.";

const formatCount = (count: number) => (count === 1 ? "1 arrangement" : `${count} arrangementer`);
const dayCounts = Object.fromEntries(days.map((day) => [day.id, day.schedule?.length ?? 0]));

const typeFromTitle = (raw: string) => {
  const value = String(raw || "").toLowerCase();
  if (value.includes("konsert")) return "Konsert";
  if (value.includes("revy")) return "Revy";
  if (value.includes("show")) return "Show";
  if (value.includes("quiz")) return "Quiz";
  if (value.includes("film")) return "Film";
  if (value.includes("temakveld")) return "Temakveld";
  if (value.includes("bar-til-bar")) return "Sosial";
  if (value.includes("etterfest") || value.includes("fest")) return "Fest";
  if (value.includes("fisketur") || value.includes("tur")) return "Tur";
  if (value.includes("sport") || value.includes("idrett") || value.includes("challenge")) return "Sport";
  if (value.includes("foredrag")) return "Foredrag";
  if (value.includes("aktivitetsdag") || value.includes("aktivitet") || value.includes("familiedag")) return "Aktivitet";
  return "Opplevelse";
};

const toneKey = (type: string) => String(type || "").toLowerCase();

const badgeClass = (type: string) => {
  const value = String(type || "").toLowerCase();
  if (value.includes("konsert")) return "bg-[#f26f7a] text-white";
  if (value.includes("revy") || value.includes("show")) return "bg-[#fdbc5b] text-neutral-900";
  if (value.includes("quiz")) return "bg-[#84d5f3] text-neutral-900";
  if (value.includes("film")) return "bg-[#eadfd0] text-neutral-900";
  if (value.includes("sport") || value.includes("aktivitet")) return "bg-[#81c997] text-neutral-900";
  if (value.includes("fest")) return "bg-[#f26f7a] text-white";
  if (value.includes("tur")) return "bg-[#84d5f3] text-neutral-900";
  return "bg-white/15 text-white";
};
---

<PageLayout title={title} description={desc}>
  <div class="program-page">
    <section id="hero" class="hero relative isolate overflow-hidden mt-20 sm:mt-24">
      <div class="mx-auto max-w-6xl px-6 pt-16 sm:pt-20 text-neutral-900">
        <p class="text-xs uppercase tracking-[0.35em] text-neutral-500">U.-KA. 2026</p>
        <h1 class="mt-3 text-4xl font-extrabold sm:text-5xl">{title}</h1>
        <p class="mt-3 text-lg text-neutral-700">{dateRange}</p>
        <p class="mt-3 max-w-2xl text-neutral-600">{desc}</p>
      </div>
    </section>

    <section class="program-section mx-auto w-full max-w-6xl px-6 pb-16 pt-6 text-neutral-900">
      <nav class="day-strip-wrap" aria-label="Hopp til dato">
        <div class="day-strip-panel">
          <div class="day-strip-head">
            <p class="day-strip-label">Hopp til dag</p>
            <p class="day-strip-sub">Rull horisontalt for å se alle dager</p>
          </div>
          <div class="day-strip-mask">
            <div class="day-strip scrollbar-hidden">
              {days.map((day) => {
                const count = dayCounts[day.id] ?? 0;
                return (
                  <a href={`#${day.id}`} class="day-pill" data-day-link={day.id}>
                    <span class="day-pill__date">{day.dateLabel ?? "Dato kommer"}</span>
                    <span class="day-pill__day">{day.label}</span>
                    <span class="day-pill__count">{formatCount(count)}</span>
                  </a>
                );
              })}
            </div>
          </div>
        </div>
      </nav>

      <div class="mt-10 space-y-10">
        {days.map((day) => {
          const events = day.schedule ?? [];
          return (
            <section id={day.id} class="day-section">
              <div class="day-section__grid">
                <header class="day-header">
                  <p class="text-xs uppercase tracking-[0.3em] text-neutral-500">{day.label}</p>
                  <h2 class="mt-2 text-2xl font-bold sm:text-3xl">{day.dateLabel ?? "Dato kommer"}</h2>
                  {day.summary && <p class="mt-2 text-sm text-neutral-600">{day.summary}</p>}
                  <span class="day-count">{formatCount(events.length)}</span>
                </header>

                <div class="day-events">
                  <div class="day-grid">
                    {events.map((event) => {
                      const type = typeFromTitle(event.title);
                      return (
                        <article class="event-card" data-tone={toneKey(type)}>
                          <div class="event-card__glow"></div>
                          <header class="flex items-center justify-between gap-3">
                            <span class={`event-tag ${badgeClass(type)}`}>{type}</span>
                            <span class="event-time">{event.time || "TBA"}</span>
                          </header>
                          <h3 class="mt-4 text-xl font-extrabold leading-tight sm:text-2xl">{event.title}</h3>
                          {event.description && <p class="mt-3 text-sm text-neutral-700">{event.description}</p>}
                          <div class="mt-5 flex flex-wrap items-center gap-2 text-xs text-neutral-600">
                            {event.location && <span class="event-meta">{event.location}</span>}
                            <span class="event-meta">{day.label}</span>
                            <span class="event-meta">{day.dateLabel ?? "Dato kommer"}</span>
                          </div>
                        </article>
                      );
                    })}
                  </div>
                </div>
              </div>
            </section>
          );
        })}
      </div>
    </section>

    <div class="mt-auto">
      <Footer />
    </div>
  </div>
</PageLayout>

<script is:inline>
  (function () {
    const links = Array.from(document.querySelectorAll("[data-day-link]"));
    if (!links.length) return;
    const setActive = () => {
      const current = (location.hash || "").replace("#", "");
      links.forEach((link) => {
        const id = link.getAttribute("data-day-link");
        link.classList.toggle("is-active", Boolean(current && id === current));
        if (current && id === current) {
          link.setAttribute("aria-current", "true");
        } else {
          link.removeAttribute("aria-current");
        }
      });
    };
    setActive();
    window.addEventListener("hashchange", setActive);
  })();
</script>

<style is:global>
  .day-strip {
    display: flex;
    gap: 0.7rem;
    overflow-x: auto;
    padding: 0.5rem 0;
    scroll-snap-type: x mandatory;
  }

  .day-strip-wrap {
    position: relative;
    z-index: 10;
    padding: 0.75rem 0 0.5rem;
    margin-top: 0;
    background: transparent;
    backdrop-filter: none;
    overflow: visible;
  }

  .day-strip-panel {
    border-radius: 1.5rem;
    border: 0;
    background: transparent;
    box-shadow: none;
    padding: 0.6rem 0;
  }

  .day-strip-head {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 0.35rem 1rem;
    padding: 0 0.35rem 0.6rem;
    align-items: baseline;
    border-bottom: 1px solid rgba(221, 190, 125, 0.6);
  }

  .day-strip-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.26em;
    font-weight: 800;
    color: #6b5a35;
  }

  .day-strip-sub {
    font-size: 0.72rem;
    color: rgba(80, 67, 40, 0.65);
  }

  .day-strip-mask {
    position: relative;
    padding-bottom: 0.35rem;
  }

  .day-strip-mask::before,
  .day-strip-mask::after {
    display: none;
  }

  .program-page {
    position: relative;
    background: #f7ecd8;
    --program-anchor-offset: 120px;
  }

  .day-pill {
    display: inline-flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    border: 1px solid rgba(210, 175, 100, 0.85);
    background: #fde8b8;
    color: #1f1f1f;
    text-decoration: none;
    min-width: 150px;
    scroll-snap-align: start;
    box-shadow: none;
    transition: transform 180ms ease, background 180ms ease, border 180ms ease;
  }

  .day-pill:hover {
    transform: translateY(-3px);
    background: #f9dc95;
    border-color: rgba(253, 188, 91, 0.95);
  }

  .day-pill.is-active {
    background: #fdbc5b;
    border-color: rgba(242, 111, 122, 0.65);
    box-shadow: none;
  }

  .day-pill.is-active .day-pill__count {
    background: rgba(255, 255, 255, 0.65);
  }

  .day-pill:focus-visible {
    outline: 2px solid rgba(253, 188, 91, 0.8);
    outline-offset: 2px;
  }

  .day-pill__day {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.18em;
    color: rgba(50, 50, 50, 0.7);
  }

  .day-pill__date {
    font-size: 1rem;
    font-weight: 800;
  }

  .day-pill__count {
    font-size: 0.7rem;
    font-weight: 700;
    color: #5f4d2a;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 999px;
    padding: 0.2rem 0.55rem;
    width: fit-content;
  }

  .day-section {
    scroll-margin-top: var(--program-anchor-offset);
  }

  .day-section__grid {
    display: grid;
    gap: 1.5rem;
  }

  @media (min-width: 1024px) {
    .day-section__grid {
      display: flex;
      align-items: flex-start;
    }
  }

  .day-header {
    position: sticky;
    top: var(--program-anchor-offset);
    align-self: start;
    background: #fde8b8;
    border: 1px solid rgba(210, 175, 100, 0.85);
    border-radius: 1.25rem;
    padding: 0.7rem 0.95rem;
    box-shadow: none;
  }

  @media (min-width: 1024px) {
    .day-header {
      top: var(--program-anchor-offset);
      flex: 0 0 260px;
    }

    .day-events {
      flex: 1 1 auto;
      min-width: 0;
    }
  }

  .day-section:target .day-header {
    border-color: rgba(242, 111, 122, 0.65);
  }

  .day-count {
    font-size: 0.8rem;
    padding: 0.35rem 0.8rem;
    border-radius: 999px;
    border: 1px solid rgba(210, 175, 100, 0.8);
    background: rgba(255, 255, 255, 0.7);
    color: #5f4d2a;
    display: inline-flex;
    margin-top: 0.75rem;
  }

  .event-card {
    position: relative;
    overflow: hidden;
    padding: 1.4rem;
    border-radius: 1.5rem;
    --event-grad-1: rgba(132, 213, 243, 0.12);
    --event-grad-2: rgba(253, 188, 91, 0.18);
    --event-border: rgba(210, 175, 100, 0.6);
    --event-shadow: rgba(253, 188, 91, 0.12);
    border: 1px solid var(--event-border);
    background:
      radial-gradient(circle at 10% 0%, var(--event-grad-1), transparent 55%),
      radial-gradient(circle at 90% 20%, var(--event-grad-2), transparent 55%),
      #fffaf2;
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    box-shadow: 0 12px 28px var(--event-shadow);
    transition: transform 200ms ease, box-shadow 200ms ease;
  }

  .event-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 18px 36px var(--event-shadow);
  }

  .event-card[data-tone="konsert"],
  .event-card[data-tone="fest"] {
    --event-grad-1: rgba(242, 111, 122, 0.22);
    --event-grad-2: rgba(253, 188, 91, 0.22);
    --event-border: rgba(242, 111, 122, 0.38);
    --event-shadow: rgba(242, 111, 122, 0.18);
  }

  .event-card[data-tone="revy"],
  .event-card[data-tone="show"] {
    --event-grad-1: rgba(253, 188, 91, 0.24);
    --event-grad-2: rgba(132, 213, 243, 0.18);
    --event-border: rgba(253, 188, 91, 0.5);
    --event-shadow: rgba(253, 188, 91, 0.18);
  }

  .event-card[data-tone="quiz"],
  .event-card[data-tone="foredrag"] {
    --event-grad-1: rgba(132, 213, 243, 0.22);
    --event-grad-2: rgba(234, 223, 208, 0.3);
    --event-border: rgba(132, 213, 243, 0.35);
    --event-shadow: rgba(132, 213, 243, 0.16);
  }

  .event-card[data-tone="aktivitet"],
  .event-card[data-tone="sport"],
  .event-card[data-tone="tur"] {
    --event-grad-1: rgba(129, 201, 151, 0.22);
    --event-grad-2: rgba(132, 213, 243, 0.18);
    --event-border: rgba(129, 201, 151, 0.4);
    --event-shadow: rgba(129, 201, 151, 0.16);
  }

  .event-card[data-tone="film"],
  .event-card[data-tone="temakveld"],
  .event-card[data-tone="sosial"] {
    --event-grad-1: rgba(234, 223, 208, 0.35);
    --event-grad-2: rgba(242, 111, 122, 0.16);
    --event-border: rgba(234, 223, 208, 0.55);
    --event-shadow: rgba(234, 223, 208, 0.18);
  }


  .event-card__glow {
    position: absolute;
    inset: auto -30% -40% auto;
    width: 220px;
    height: 220px;
    background: radial-gradient(circle at 30% 30%, rgba(253, 188, 91, 0.18), rgba(242, 111, 122, 0.08), transparent 70%);
    filter: blur(16px);
    opacity: 0.5;
    pointer-events: none;
  }

  .event-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.3rem 0.75rem;
    border-radius: 999px;
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .event-time {
    font-size: 0.75rem;
    font-weight: 600;
    color: #6b5a35;
  }

  .event-meta {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.2rem 0.65rem;
    border-radius: 999px;
    border: 1px solid rgba(210, 175, 100, 0.45);
    background: rgba(255, 255, 255, 0.7);
    color: #5f4d2a;
  }

  .day-grid {
    display: grid;
    gap: 1.25rem;
    grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
  }

  @media (min-width: 640px) {
    .day-grid {
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }
  }

  @media (min-width: 1280px) {
    .day-grid {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }
  }
</style>
