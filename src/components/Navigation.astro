---
import MenuIcon from "../assets/images/menu.svg";
import CtaButton from "../components/CtaButton.astro";
import LogoSvg from "../assets/images/logo.svg";

// `disabled` is optional; when true, the item is rendered non-interactive
const links = [
  { name: "Forside", href: "/" },
  { name: "Program", href: "/program" },
  { name: "Revyen", href: "/revy" },
];

const ticketLink = { name: "Billetter", href: "https://tikkio.com/organizer/2624-ass-alesund-studentsamfunn" };
const currentPath = Astro.url?.pathname || "/";
---

<header id="site-header" class="fixed top-0 left-0 w-full z-50">
  <nav id="site-nav" class="px-8 lg:px-16 py-4 text-white transition-colors">
    <div class="flex items-center justify-between w-full mx-auto">
      <!-- Logo -->
      <a href="/" draggable="false" class="flex items-center gap-2 nav-logo">
        <LogoSvg class="w-auto h-9" />
        <span class="logo-wordmark text-lg font-extrabold tracking-[0.02em] leading-none">U.-KA.</span>
      </a>

      <!-- Desktop Menu -->
      <div class="items-center hidden gap-6 text-nowrap font-medium md:flex">
        {
          links.map((l) =>
            l.disabled ? (
              <span aria-disabled="true" class="relative opacity-60 cursor-default select-none">
                {l.name}
              </span>
            ) : (
              <a href={l.href} target={l.href.startsWith("http") ? "_blank" : undefined} rel={l.href.startsWith("http") ? "noreferrer" : undefined} class={`relative transition-colors duration-300 hover:opacity-90 ${currentPath === l.href ? "nav-link--active" : ""}`}>
                {l.name}
              </a>
            )
          )
        }

        <!-- CTA Button (enabled, matches CtaSection style) -->
        <CtaButton label={ticketLink.name} href={ticketLink.href} newTab variant="tikkio" class="px-5 py-2 ml-4 rounded-full text-sm hover:translate-y-0 shadow-sm" />
      </div>

      <!-- Mobile CTA + Menu Button -->
      <div class="flex items-center gap-3 md:hidden">
        <CtaButton label={ticketLink.name} href={ticketLink.href} variant="tikkio" class="px-4 py-2 text-sm whitespace-nowrap hover:translate-y-0 shadow-sm" />
        <button type="button" data-menu-btn class="flex items-center hover:cursor-pointer hover:opacity-90 focus:outline-none" aria-label="Ã…pne meny">
          <MenuIcon class="w-6 h-6" />
        </button>
      </div>
    </div>

    <!-- Mobile Menu -->
    <div data-mobile_menu data-mobile-menu id="mobile-nav-menu" class="text-nowrap flex-col py-5 space-y-5 md:hidden">
      {
        links.map((l) =>
          l.disabled ? (
            <span aria-disabled="true" class="block font-medium opacity-50 cursor-default select-none">
              {l.name}
            </span>
          ) : (
            <a href={l.href} target={l.href.startsWith("http") ? "_blank" : undefined} rel={l.href.startsWith("http") ? "noreferrer" : undefined} class={`block font-medium transition-colors ${currentPath === l.href ? "nav-link--active" : "opacity-80 hover:opacity-100"}`}>
              {l.name}
            </a>
          )
        )
      }
      <!-- CTA moved into the top bar on mobile -->
    </div>
  </nav>
</header>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const nav = document.getElementById("site-nav");
    if (!nav) return;

    const btn = nav.querySelector("[data-menu-btn]");
    const menu = nav.querySelector("[data-mobile_menu],[data-mobile-menu]") || nav.querySelector("[data-mobile-menu]");
    if (btn && menu) {
      // a11y
      btn.setAttribute("aria-controls", "mobile-nav-menu");
      btn.setAttribute("aria-expanded", "false");

      const toggleMenu = () => {
        const isOpen = menu.classList.toggle("open");
        btn.setAttribute("aria-expanded", isOpen ? "true" : "false");
        // Stretch nav overlays to cover dropdown height
        if (isOpen) {
          const h = menu.scrollHeight;
          nav.classList.add("menu-open");
          nav.style.setProperty("--menu-h", h + "px");
        } else {
          nav.classList.remove("menu-open");
          nav.style.setProperty("--menu-h", "0px");
        }
      };
      btn.addEventListener("click", toggleMenu);
    }

    // Constants
    const THEME_DARK = "#fdbc5b"; // over hero
    const THEME_LIGHT = "#eadfd0"; // past hero (light surface)
    const OFFSET_Y = 50; // early switch before bottom of hero hits nav

    // Only enable scroll-based tone change on the index page
    const isHome = location.pathname === "/" || location.pathname === "/index.html";
    if (isHome) {
      const hero = document.querySelector(".hero") || document.getElementById("hero") || document.querySelector("section.hero");
      const navH = nav.offsetHeight || 64;

      const setThemeColor = (hex) => {
        const tags = document.querySelectorAll('meta[name="theme-color"]');
        tags.forEach((m) => m.setAttribute("content", hex));
      };

      const updateTone = () => {
        if (!hero) return;
        const rect = hero.getBoundingClientRect();
        const pastHero = rect.bottom <= navH + OFFSET_Y;
        nav.classList.toggle("past-hero", pastHero);
        setThemeColor(pastHero ? THEME_LIGHT : THEME_DARK);
      };

      updateTone();
      window.addEventListener("scroll", updateTone, { passive: true });
      window.addEventListener("resize", updateTone);
    }
  });
</script>

<style is:global>
  .nav-dropdown {
    position: relative;
    display: inline-flex;
    align-items: center;
  }

  .nav-dropdown::after {
    content: "";
    position: absolute;
    left: -0.5rem;
    right: -0.5rem;
    top: 100%;
    height: 0.6rem;
  }

  .nav-dropdown__trigger {
    background: none;
    border: 0;
    color: inherit;
    font: inherit;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0;
  }

  .nav-dropdown__trigger::after {
    content: "";
    display: inline-block;
    width: 0.4rem;
    height: 0.4rem;
    border-right: 2px solid currentColor;
    border-bottom: 2px solid currentColor;
    transform: rotate(45deg);
    margin-top: -2px;
  }

  .nav-dropdown__menu {
    position: absolute;
    top: 100%;
    left: -0.5rem;
    min-width: 170px;
    background: rgb(15, 23, 42);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    padding: 0.5rem;
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.4);
    opacity: 0;
    transform: translateY(-6px);
    pointer-events: none;
    transition:
      opacity 160ms ease,
      transform 160ms ease;
    z-index: 40;
  }

  .nav-dropdown__item {
    display: block;
    padding: 0.4rem 0.6rem;
    border-radius: 8px;
    color: #fff;
    font-size: 0.85rem;
    transition:
      background 150ms ease,
      color 150ms ease;
  }

  .nav-dropdown__item:hover {
    background: rgba(255, 255, 255, 0.12);
  }

  .nav-dropdown__meta {
    display: block;
    padding: 0.4rem 0.6rem 0.2rem;
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.7);
  }

  .nav-dropdown:hover .nav-dropdown__menu,
  .nav-dropdown:focus-within .nav-dropdown__menu {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .mobile-dropdown {
    border: 0;
  }

  .mobile-dropdown__summary {
    list-style: none;
    display: flex;
    align-items: center;
    gap: 0.35rem;
    font-weight: 500;
    cursor: pointer;
  }

  .mobile-dropdown__summary::-webkit-details-marker {
    display: none;
  }

  .mobile-dropdown__summary::after {
    content: "";
    display: inline-block;
    width: 0.4rem;
    height: 0.4rem;
    border-right: 2px solid currentColor;
    border-bottom: 2px solid currentColor;
    transform: rotate(45deg);
    margin-top: -2px;
  }

  .mobile-dropdown[open] .mobile-dropdown__summary::after {
    transform: rotate(-135deg);
  }

  .mobile-dropdown__content {
    padding-top: 0.4rem;
  }

  /* Mobile menu animation */
  #site-nav [data-mobile-menu] {
    position: absolute;
    left: 0;
    right: 0;
    top: 100%;
    z-index: 20;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-4px) scale(0.98);
    transition:
      opacity 0ms ease,
      visibility 0ms ease,
      transform 200ms ease;
    overflow: hidden;
    pointer-events: none;
    isolation: isolate; /* ensure ::before stays behind content */
    background: transparent;
    border: 0;
  }
  #site-nav [data-mobile-menu].open {
    position: static; /* allow header to expand with dropdown */
    left: auto;
    right: auto;
    top: auto;
    opacity: 1;
    visibility: visible;
    transform: none;
    pointer-events: auto;
  }

  /* Blur the actual dropdown element via its ID */
  #mobile-nav-menu {
    /* No inner background; rely on header glass */
    background: transparent;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 0;
    border-radius: 0;
    box-shadow: none;
  }

  /* Header glass background (no pseudo elements) */
  #site-header {
    isolation: isolate;
    background: linear-gradient(120deg, rgb(253, 188, 91), rgb(253, 188, 91));
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border-bottom: 1px solid rgb(253, 188, 91);
    box-shadow: 0 8px 20px rgba(253, 188, 91, 0.12);
    opacity: 1;
    transform: translateY(0);
    transition:
      opacity 220ms ease,
      transform 280ms ease,
      background 260ms ease,
      border-color 260ms ease,
      box-shadow 260ms ease;
  }

  body.hero-video-playing #site-header {
    background: linear-gradient(120deg, rgb(253, 188, 91), rgb(253, 188, 91));
    border-bottom: 1px solid rgb(253, 188, 91);
    box-shadow: 0 8px 20px rgba(253, 188, 91, 0.12);
  }

  body.hero-video-playing.hero-nav-hidden #site-header {
    opacity: 0;
    transform: translateY(-110%);
    pointer-events: none;
  }

  /* Nav text color (fixed, no scroll-based changes) */
  #site-nav,
  #site-nav a,
  #site-nav .nav-logo {
    color: #1b1b1b;
  }
  /* Ensure logo keeps brand colors (avoid inherited fills) */
  #site-nav .nav-logo svg .cls-1 { fill: #f26f7a; }
  #site-nav .nav-logo svg .cls-2 { fill: #eadfd0; }
  #site-nav .nav-logo svg .cls-3 { fill: #84d5f3; }
  #site-nav .nav-logo svg .cls-4 { fill: #fdbc5b; }
  #site-nav .nav-logo svg .cls-5 { fill: #81c997; }
  #site-nav .nav-logo svg {
    filter:
      drop-shadow(0 1px 1px rgba(0, 0, 0, 1));
  }
  /* Active page indicator */
  .nav-link--active {
    font-weight: 700;
    position: relative;
  }
  .nav-link--active::after {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    bottom: -4px;
    height: 2.5px;
    background: #1b1b1b;
    border-radius: 999px;
  }

  #site-nav .cta-btn {
    color: #fff;
  }
  #site-nav {
    border-color: rgba(253, 188, 91, 0.55);
  }
</style>
